openapi: 3.0.0
info:
  title: Ecotech HR API
  description: API untuk layanan HR internal, termasuk profil karyawan dan manajemen cuti.
  version: 1.0.0
servers:
  - url: https://ecomate-e3b5cshbgcewfehz.canadacentral-01.azurewebsites.net
    description: Server Produksi di Azure
  - url: http://localhost:3000
    description: Server development lokal

paths:
  /login:
    get:
      summary: Memulai alur login
      description: Mengalihkan user ke halaman login Microsoft Azure AD.
      responses:
        '302':
          description: Berhasil dialihkan ke halaman login Microsoft.

  /auth/callback:
    get:
      summary: Callback setelah login
      description: Menangani callback dari Azure AD, menukar authorization code dengan token, dan membuat session.
      responses:
        '200':
          description: Login berhasil, session dibuat.
        '500':
          description: Gagal mendapatkan token.

  /whoami:
    get:
      summary: Get Current User Identity
      description: Mengambil informasi identitas user yang sedang login dari Dataverse.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Data identitas berhasil diambil.
        '401':
          description: Tidak terautentikasi.
        '500':
          description: Gagal memanggil Dataverse.

  /healthz:
    get:
      summary: Health Check
      description: Memeriksa status server.
      responses:
        '200':
          description: Server berjalan dengan baik.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /profile/personal-info:
    get:
      summary: Get Own Profile
      description: Mengambil data personal lengkap milik user yang sedang login.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Data profil berhasil diambil.
        '401':
          description: Tidak terautentikasi (belum login).
        '404':
          description: Data tidak ditemukan.

  /admin/profile/search:
    get:
      summary: Admin: Search and Get Employee Profile
      description: (Admin) Mengambil data personal lengkap karyawan berdasarkan GUID, Employee Code (e.g., ES-0022), email, atau nama. Hanya untuk Admin.
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: GUID dari karyawan yang ingin dilihat.
        - name: code
          in: query
          required: false
          schema:
            type: string
          description: Employee Code (e.g., ES-0022) dari karyawan yang ingin dilihat.
        - name: email
          in: query
          required: false
          schema:
            type: string
            format: email
          description: Email karyawan yang ingin dicari.
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Nama karyawan yang ingin dicari.
      responses:
        '200':
          description: Daftar profil karyawan berhasil diambil.
        '400':
          description: Parameter pencarian tidak valid. Setidaknya satu dari 'id', 'code', 'email', atau 'name' harus diberikan.
        '403':
          description: Akses ditolak (bukan admin).
        '404':
          description: Karyawan tidak ditemukan.

  /profile/{employeeId}:
    patch:
      summary: Update Profile (Admin)
      description: (Admin) Memperbarui data personal seorang karyawan.
      security:
        - cookieAuth: []
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: GUID dari karyawan yang ingin diubah.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ecom_gender:
                  type: integer
                ecom_dateofbirth:
                  type: string
                  format: date
                ecom_phonenumber:
                  type: string
                ecom_emergencycontactname:
                  type: string
                ecom_emergencycontactaddress:
                  type: string
                ecom_emergencycontractphonenumber:
                  type: string
                ecom_emergencycontactrelationship:
                  type: string
                ecom_address:
                  type: string
                ecom_ktpnumber:
                  type: string
                ecom_npwpnumber:
                  type: string
                ecom_notes:
                  type: string
                ecom_bankaccountnumber:
                  type: string
                ecom_bpjsnumber:
                  type: string
                ecom_bpjstknumber:
                  type: string
                ecom_maritalstatus:
                  type: integer
                ecom_numberofdependent:
                  type: integer
                ecom_placeofbirth:
                  type: string
                ecom_religion:
                  type: integer
                ecom_bankname:
                  type: string
                ecom_personalemail:
                  type: string
                  format: email
                ecom_workexperience:
                  type: string
              example:
                ecom_address: "Alamat baru"
                ecom_phonenumber: "08123456789"
      responses:
        '200':
          description: Profil berhasil diperbarui.
        '400':
          description: Tidak ada data valid untuk diubah.
        '403':
          description: Akses ditolak (bukan admin).

  /leave-preview:
    post:
      summary: Leave Preview
      description: Menghitung tanggal selesai cuti berdasarkan tanggal mulai dan jumlah hari.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                start_date:
                  type: string
                  format: date
                days:
                  type: integer
              required:
                - start_date
                - days
              example:
                start_date: "2025-12-20"
                days: 5
      responses:
        '200':
          description: Preview berhasil dihitung.
        '400':
          description: Input tidak valid (misal, tanggal mulai di masa lalu atau akhir pekan).

  /leave/types:
    get:
      summary: Get All Leave Types
      description: Mengambil daftar semua tipe cuti yang aktif.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Berhasil mengambil daftar tipe cuti.

  /leave/balance:
    get:
      summary: Get Saldo Cuti User
      description: Mengambil informasi saldo cuti milik user yang sedang login.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Berhasil mengambil data saldo.
        '404':
          description: Data saldo cuti untuk user ini tidak ditemukan.

  /leave/requests:
    get:
      summary: Get User's Leave Requests
      description: Mengambil riwayat pengajuan cuti milik user yang sedang login.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Berhasil mengambil riwayat cuti.
    post:
      summary: Apply for Leave
      description: Mengajukan cuti baru.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                leaveTypeId:
                  type: string
                  format: uuid
                startDate:
                  type: string
                  format: date
                days:
                  type: integer
                reason:
                  type: string
              example:
                leaveTypeId: "guid-tipe-cuti"
                startDate: "2025-12-20"
                days: 3
                reason: "Liburan akhir tahun"
      responses:
        '201':
          description: Pengajuan cuti berhasil dibuat.
        '400':
          description: Saldo tidak cukup atau data tidak lengkap.

  /leave/requests/{leaveId}/cancel:
    post:
      summary: Cancel a Leave Request
      description: Membatalkan pengajuan cuti yang statusnya masih 'Pending'.
      security:
        - cookieAuth: []
      parameters:
        - name: leaveId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID dari pengajuan cuti yang ingin dibatalkan.
      responses:
        '200':
          description: Cuti berhasil dibatalkan.
        '400':
          description: Hanya cuti 'Pending' yang bisa dibatalkan.
        '403':
          description: Akses ditolak.

  /admin/leave-requests:
    get:
      summary: Admin: List all leave requests
      description: (Admin) Mengambil semua pengajuan cuti dari semua karyawan.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Berhasil mengambil semua data pengajuan cuti.
        '403':
          description: Akses ditolak (bukan admin).

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: sessionId