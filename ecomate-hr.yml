openapi: 3.0.0
info:
  title: Ecotech HR API
  description: 'API untuk layanan HR internal, termasuk profil karyawan dan manajemen cuti.'
  version: 1.1.0
servers:
  - url: https://ecomate-e3b5cshbgcewfehz.canadacentral-01.azurewebsites.net
    description: Server Produksi di Azure
  - url: http://localhost:3000
    description: Server development lokal

paths:
  /login:
    get:
      summary: 1. Memulai Alur Login
      description: Mengalihkan pengguna ke halaman login Microsoft Azure AD untuk autentikasi.
      responses:
        '302':
          description: Berhasil dialihkan ke halaman login Microsoft.

  /auth/callback:
    get:
      summary: 2. Callback & Menampilkan OTP
      description: Menangani callback dari Azure AD. Jika sukses, menampilkan halaman HTML dengan 6-digit OTP yang berlaku 5 menit.
      responses:
        '200':
          description: Sukses. Menampilkan halaman HTML dengan kode OTP.
          content:
            text/html: {}
        '500':
          description: Gagal mendapatkan token dari Microsoft.

  /exchange-otp:
    post:
      summary: 3. Menukar OTP dengan API Key
      description: Endpoint untuk agent AI (Pusaka) menukarkan 6-digit OTP dengan API Key (JWT) jangka panjang.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                otp:
                  type: string
                  description: 6-digit OTP yang didapat dari halaman callback.
              required:
                - otp
              example:
                otp: "123456"
      responses:
        '200':
          description: Berhasil menukar OTP. Mengembalikan API Key.
          content:
            application/json:
              schema:
                type: object
                properties:
                  apiKey:
                    type: string
                    description: API Key (JWT) yang berlaku selama 90 hari.
        '400':
          description: OTP tidak disertakan dalam request body.
        '404':
          description: OTP tidak valid atau sudah kedaluwarsa.

  /whoami:
    get:
      summary: Get Current User Identity
      description: 'Mengambil informasi identitas user yang sedang login, baik via Cookie maupun API Key.'
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Data identitas berhasil diambil.
        '401':
          description: Tidak terautentikasi.

  /healthz:
    get:
      summary: Health Check
      description: Memeriksa status server.
      responses:
        '200':
          description: Server berjalan dengan baik.

  /profile/personal-info:
    get:
      summary: Get Own Profile
      description: 'Mengambil data personal lengkap milik user yang sedang login.'
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Data profil berhasil diambil.
        '401':
          description: 'Tidak terautentikasi (belum login).'
        '404':
          description: Data tidak ditemukan.

  /admin/profile/search:
    get:
      summary: 'Admin: Search and Get Employee Profile'
      description: '(Admin) Mengambil data personal lengkap karyawan berdasarkan kriteria.'
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: id
          in: query
          schema:
            type: string
          description: 'GUID dari karyawan.'
        - name: code
          in: query
          schema:
            type: string
          description: 'Employee Code (e.g., ES-0022).'
        - name: email
          in: query
          schema:
            type: string
          description: 'Email karyawan.'
        - name: name
          in: query
          schema:
            type: string
          description: 'Nama karyawan.'
      responses:
        '200':
          description: Daftar profil karyawan berhasil diambil.
        '403':
          description: 'Akses ditolak (bukan admin).'

  /profile/{employeeId}:
    patch:
      summary: 'Update Profile (Admin)'
      description: '(Admin) Memperbarui data personal seorang karyawan.'
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: employeeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 'GUID dari karyawan yang ingin diubah.'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ecom_employeename:
                  type: string
                  description: 'Nama lengkap karyawan.'
                ecom_gender:
                  type: integer
                  description: 'Jenis kelamin karyawan (misal: 1 untuk Pria, 2 untuk Wanita).'
                ecom_dateofbirth:
                  type: string
                  format: date
                  description: 'Tanggal lahir karyawan (YYYY-MM-DD).'
                ecom_phonenumber:
                  type: string
                  description: 'Nomor telepon karyawan.'
                statecode:
                  type: integer
                  description: 'Status record (misal: 0 untuk Aktif, 1 untuk Tidak Aktif).'
                ecom_startwork:
                  type: string
                  format: date
                  description: 'Tanggal mulai bekerja (YYYY-MM-DD).'
                ecom_jobtitle:
                  type: string
                  description: 'Jabatan karyawan.'
                ecom_workexperience:
                  type: string
                  description: 'Pengalaman kerja karyawan.'
                ecom_dateofemployment:
                  type: string
                  format: date
                  description: 'Tanggal mulai bekerja (YYYY-MM-DD).'
                ecom_emergencycontactname:
                  type: string
                  description: 'Nama kontak darurat.'
                ecom_emergencycontactaddress:
                  type: string
                  description: 'Alamat kontak darurat.'
                ecom_emergencycontractphonenumber:
                  type: string
                  description: 'Nomor telepon kontak darurat.'
                ecom_relationship:
                  type: string
                  description: 'Hubungan dengan kontak darurat.'
                ecom_address:
                  type: string
                  description: 'Alamat lengkap karyawan.'
                ecom_ktpnumber:
                  type: string
                  description: 'Nomor KTP.'
                ecom_npwpnumber:
                  type: string
                  description: 'Nomor NPWP.'
                ecom_profilepicture:
                  type: string
                  format: uri
                  description: 'URL gambar profil.'
                ecom_bankaccountnumber:
                  type: string
                  description: 'Nomor rekening bank.'
                ecom_bpjsnumber:
                  type: string
                  description: 'Nomor BPJS Kesehatan.'
                ecom_insurancenumber:
                  type: string
                  description: 'Nomor asuransi lainnya.'
                ecom_bpjstknumber:
                  type: string
                  description: 'Nomor BPJS Ketenagakerjaan.'
                ecom_maritalstatus:
                  type: integer
                  description: 'Status pernikahan (misal: 1 untuk Lajang, 2 untuk Menikah).'
                ecom_numberofdependent:
                  type: integer
                  description: 'Jumlah tanggungan.'
                ecom_placeofbirth:
                  type: string
                  description: 'Tempat lahir.'
                ecom_religion:
                  type: string
                  description: 'Agama.'
                ecom_bankname:
                  type: string
                  description: 'Nama bank.'
                ecom_personalemail:
                  type: string
                  format: email
                  description: 'Email pribadi.'
                ecom_workemail:
                  type: string
                  format: email
                  description: 'Email kantor.'
              example:
                ecom_employeename: "Budi Santoso"
                ecom_phonenumber: "081234567890"
                ecom_jobtitle: "Senior Developer"
      responses:
        '200':
          description: Profil berhasil diperbarui.
        '403':
          description: 'Akses ditolak (bukan admin).'

  

  # ... (semua endpoint Cuti lainnya juga perlu ditambahkan security) ...
  /leave/types:
    get:
      summary: Get All Leave Types
      security:
        - cookieAuth: []
        - bearerAuth: []
      # ... (sisa definisi sama)

  /leave/balance:
    get:
      summary: Get Saldo Cuti User
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: period
          in: query
          required: true
          schema:
            type: string
          description: 'Periode tahun yang ingin diperiksa (contoh: 2023).'
      responses:
        '200':
          description: Saldo cuti berhasil diambil.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    leave_type_id:
                      type: string
                    leave_type_name:
                      type: string
                    quota:
                      type: integer
                    balance:
                      type: integer
                    end_date:
                      type: string
                      format: date-time

  /leave/history:
    get:
      summary: Get User's Non-Annual Leave History
      description: 'Mengambil riwayat penggunaan cuti non-tahunan (contoh: Cuti Haji, Cuti Melahirkan) dari tabel ecom_leave.'
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: year
          in: query
          schema:
            type: string
          description: 'Tahun untuk memfilter riwayat cuti (contoh: 2023).'
        - name: type
          in: query
          schema:
            type: string
          description: 'Nama jenis cuti untuk memfilter (contoh: Cuti Sakit).'
      responses:
        '200':
          description: Riwayat cuti berhasil diambil.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  filtersUsed:
                    type: object
                    properties:
                      year:
                        type: string
                      type:
                        type: string
                  totalRecords:
                    type: integer
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        leaveName:
                          type: string
                        leaveType:
                          type: string
                        startDate:
                          type: string
                          format: date
                        endDate:
                          type: string
                          format: date
                        numberOfDays:
                          type: integer
                        status:
                          type: integer
        '500':
          description: Gagal mengambil data.

  /leave/requests:
    get:
      summary: "Get User's Leave Requests"
      security:
        - cookieAuth: []
        - bearerAuth: []
      # ... (sisa definisi sama)
    post:
      summary: Apply for Leave
      description: Mengajukan permintaan cuti baru. Validasi akan dilakukan untuk memastikan tanggal mulai adalah hari kerja dan saldo mencukupi.
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                leaveTypeId:
                  type: string
                  format: uuid
                  description: "ID dari jenis cuti yang ingin diambil."
                startDate:
                  type: string
                  format: date
                  description: "Tanggal mulai cuti (YYYY-MM-DD)."
                days:
                  type: integer
                  description: "Jumlah hari cuti yang ingin diambil."
                reason:
                  type: string
                  description: "Alasan mengambil cuti (opsional)."
              required:
                - leaveTypeId
                - startDate
                - days
      responses:
        '201':
          description: Permintaan cuti berhasil dibuat.
        '400':
          description: Input tidak valid (misal: tanggal di masa lalu, bukan hari kerja, atau saldo tidak cukup).
        '401':
          description: Tidak terautentikasi.
        '404':
          description: Jenis cuti atau data saldo tidak ditemukan.

  /leave/requests/special:
    post:
      summary: Apply for Special Leave (Quota-based)
      description: Mengajukan permintaan cuti khusus (di luar cuti tahunan) yang validasinya berdasarkan kuota, bukan sisa saldo. Contoh: Cuti Sakit, Cuti Menikah.
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                leaveTypeId:
                  type: string
                  format: uuid
                  description: "ID dari jenis cuti yang ingin diambil."
                startDate:
                  type: string
                  format: date
                  description: "Tanggal mulai cuti (YYYY-MM-DD)."
                days:
                  type: integer
                  description: "Jumlah hari cuti yang ingin diambil."
                reason:
                  type: string
                  description: "Alasan mengambil cuti (opsional)."
              required:
                - leaveTypeId
                - startDate
                - days
      responses:
        '201':
          description: Permintaan cuti khusus berhasil dibuat.
        '400':
          description: Input tidak valid (misal: tanggal di masa lalu, atau kuota tidak mencukupi).
        '401':
          description: Tidak terautentikasi.
        '404':
          description: Jenis cuti tidak ditemukan.

  /leave/requests/{leaveId}/cancel:
    post:
      summary: Cancel a Leave Request
      security:
        - cookieAuth: []
        - bearerAuth: []
      # ... (sisa definisi sama)

  /admin/leave-requests:
    get:
      summary: 'Admin: List all leave requests'
      description: "(Admin) Mengambil daftar semua permintaan cuti dari seluruh karyawan."
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Daftar permintaan cuti berhasil diambil.
        '401':
          description: Tidak terautentikasi.
        '403':
          description: Akses ditolak (bukan admin).

  /admin/leave-requests/search:
    get:
      summary: "Admin: Search for employee's leave requests"
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: employeeId
          in: query
          schema:
            type: string
          description: 'GUID dari karyawan.'
        - name: email
          in: query
          schema:
            type: string
          description: 'Email karyawan.'
        - name: name
          in: query
          schema:
            type: string
          description: 'Nama karyawan.'
      responses:
        '200':
          description: Daftar permintaan cuti karyawan berhasil diambil.
        '403':
          description: 'Akses ditolak (bukan admin).'

  /admin/leave-balance/search:
    get:
      summary: "Admin: Search for employee's leave balance"
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: period
          in: query
          required: true
          schema:
            type: string
          description: 'Periode tahun yang ingin diperiksa (contoh: 2023).'
        - name: employeeId
          in: query
          schema:
            type: string
          description: 'GUID dari karyawan.'
        - name: email
          in: query
          schema:
            type: string
          description: 'Email karyawan.'
        - name: name
          in: query
          schema:
            type: string
          description: 'Nama karyawan.'
      responses:
        '200':
          description: Daftar saldo cuti karyawan berhasil diambil.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    leave_type_id:
                      type: string
                    leave_type_name:
                      type: string
                    quota:
                      type: integer
                    balance:
                      type: integer
                    end_date:
                      type: string
                      format: date-time
        '403':
          description: 'Akses ditolak (bukan admin).'

  /admin/leave-history/search:
    get:
      summary: "Admin: Search for employee's non-annual leave history"
      description: 'Mengambil riwayat penggunaan cuti non-tahunan karyawan lain berdasarkan kriteria.'
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: employeeId
          in: query
          schema:
            type: string
          description: 'GUID dari karyawan.'
        - name: email
          in: query
          schema:
            type: string
          description: 'Email karyawan.'
        - name: name
          in: query
          schema:
            type: string
          description: 'Nama karyawan.'
        - name: year
          in: query
          schema:
            type: string
          description: 'Tahun untuk memfilter riwayat cuti (contoh: 2023).'
        - name: type
          in: query
          schema:
            type: string
          description: 'Nama jenis cuti untuk memfilter (contoh: Cuti Sakit).'
      responses:
        '200':
          description: Riwayat cuti berhasil diambil.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    leave_type_name:
                      type: string
                    start_date:
                      type: string
                      format: date
                    end_date:
                      type: string
                      format: date
                    number_of_days:
                      type: integer
        '403':
          description: 'Akses ditolak (bukan admin).'

  /developments:
    get:
      summary: Get Own Project History
      description: Mengambil riwayat keterlibatan proyek dan pengembangan (training, sertifikasi) milik user yang sedang login.
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: Riwayat proyek berhasil diambil.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    title:
                      type: string
                    type_code:
                      type: integer
                    type_label:
                      type: string
                      enum: [Project, Training, Certification, Onboarding, Unknown]
                    start_date:
                      type: string
                      format: date
                    end_date:
                      type: string
                      format: date
                    involvement_percentage:
                      type: string
                    client_name:
                      type: string
                      nullable: true
                    project_manager_name:
                      type: string
                      nullable: true
                    created_by_name:
                      type: string
                      nullable: true
                    last_updated_on:
                      type: string
                      format: date-time
                  example:
                    id: "f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
                    title: "Implementasi Dynamics 365"
                    type_code: 273700000
                    type_label: "Project"
                    start_date: "2023-01-15"
                    end_date: "2023-06-30"
                    involvement_percentage: "80%"
                    client_name: "PT Sejahtera Abadi"
                    project_manager_name: "John Doe"
                    created_by_name: "Admin User"
                    last_updated_on: "2023-07-01T10:00:00Z"
        '401':
          description: Tidak terautentikasi.

  /admin/developments/search:
    get:
      summary: "Admin: Search Project History"
      description: Admin dapat mencari riwayat proyek/pengembangan milik karyawan berdasarkan email atau nama.
      security:
        - cookieAuth: []
        - bearerAuth: []
      parameters:
        - name: email
          in: query
          schema:
            type: string
          description: "Email karyawan yang ingin dicari."
        - name: name
          in: query
          schema:
            type: string
          description: "Nama karyawan yang ingin dicari."
      responses:
        '200':
          description: Riwayat proyek karyawan berhasil diambil.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/paths/~1developments/get/responses/200/content/application~1json/schema/items'
        '400':
          description: Parameter query 'email' atau 'name' tidak disediakan.
        '401':
          description: Tidak terautentikasi.
        '403':
          description: Akses ditolak (bukan admin).
        '404':
          description: Karyawan dengan email/nama tersebut tidak ditemukan.

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: sessionId
      description: Autentikasi berbasis sesi cookie untuk interaksi via browser.
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Autentikasi berbasis Bearer Token (API Key) untuk agent AI atau sistem eksternal.